name: Release SDK & CLI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  publish-sdk:
    name: Publish SDK to npm
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Build SDK
      run: bun run build
    
    - name: Run tests
      run: bun test
    
    - name: Publish to npm
      run: npm publish --provenance --access public
    
    - name: Create tarball for GitHub release
      run: |
        tar -czf grapevine-sdk-${{ github.ref_name }}.tar.gz dist/ package.json README.md
    
    - name: Upload SDK package
      uses: actions/upload-artifact@v4
      with:
        name: sdk-package
        path: '*.tar.gz'
        retention-days: 7

  publish-cli:
    name: Publish CLI to npm
    needs: [build-cli-executables]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Download all CLI artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Prepare CLI package
      run: |
        mkdir -p cli-npm-package/bin
        
        # Extract all executables from artifacts
        cd artifacts
        
        # Linux
        cd cli-linux && tar -xzf grapevine-cli-linux.tar.gz && cd ..
        cp cli-linux/grapevine-linux cli-npm-package/bin/grapevine-linux-x64
        
        # macOS x64
        cd cli-macos-x64 && tar -xzf grapevine-cli-macos-x64.tar.gz && cd ..
        cp cli-macos-x64/grapevine-macos-x64 cli-npm-package/bin/grapevine-darwin-x64
        
        # macOS ARM64
        cd cli-macos-arm64 && tar -xzf grapevine-cli-macos-arm64.tar.gz && cd ..
        cp cli-macos-arm64/grapevine-macos-arm64 cli-npm-package/bin/grapevine-darwin-arm64
        
        # Windows
        cd cli-windows && unzip grapevine-cli-windows.zip && cd ..
        cp cli-windows/grapevine-windows.exe cli-npm-package/bin/grapevine-win32-x64.exe
        
        cd ..
        
        # Make binaries executable
        chmod +x cli-npm-package/bin/grapevine-*
        
        # Copy package files and shim
        cp src/cli/cli-package.json cli-npm-package/package.json
        cp src/cli/cli-shim.js cli-npm-package/grapevine.js
        cp README.md cli-npm-package/
    
    - name: Publish CLI to npm
      working-directory: cli-npm-package
      run: npm publish --provenance --access public

  build-cli-executables:
    name: Build CLI for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            target: linux
          - os: macos-latest
            platform: macos-x64
            target: macos-x64
          - os: macos-latest
            platform: macos-arm64
            target: macos-arm
          - os: windows-latest
            platform: windows
            target: windows
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Build TypeScript
      run: bun run build
    
    - name: Build CLI executable
      run: bun run build:cli:${{ matrix.target }}
    
    - name: Create archive (Unix)
      if: runner.os != 'Windows'
      run: |
        cd dist/bin
        if [ "${{ matrix.platform }}" == "macos-arm64" ]; then
          tar -czf grapevine-cli-${{ matrix.platform }}.tar.gz grapevine-macos-arm64
        elif [ "${{ matrix.platform }}" == "macos-x64" ]; then
          tar -czf grapevine-cli-${{ matrix.platform }}.tar.gz grapevine-macos-x64
        else
          tar -czf grapevine-cli-${{ matrix.platform }}.tar.gz grapevine-${{ matrix.platform }}
        fi
    
    - name: Create archive (Windows)
      if: runner.os == 'Windows'
      run: |
        cd dist\bin
        Compress-Archive -Path grapevine-windows.exe -DestinationPath grapevine-cli-windows.zip
    
    - name: Upload CLI executable
      uses: actions/upload-artifact@v4
      with:
        name: cli-${{ matrix.platform }}
        path: dist/bin/grapevine-cli-${{ matrix.platform }}.*
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [publish-sdk, publish-cli, build-cli-executables]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # Copy SDK package
        cp artifacts/sdk-package/*.tar.gz release-assets/
        
        # Copy CLI executables
        find artifacts -name "grapevine-cli-*" -type f -exec cp {} release-assets/ \;
        
        # List all assets
        ls -la release-assets/
    
    - name: Extract version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release Notes
      run: |
        cat > release-notes.md << EOF
        # Grapevine SDK & CLI Release v${{ steps.version.outputs.VERSION }}
        
        ## ðŸ“¦ SDK Package
        - **npm**: \`npm install @pinata/grapevine-sdk\`
        - **GitHub**: Download the tarball from release assets
        - TypeScript/JavaScript SDK for Grapevine API with wagmi integration
        
        ## ðŸ–¥ï¸ CLI 
        ### npm Installation (Recommended)
        \`\`\`bash
        npm install -g @pinata/grapevine-cli
        # Then use: grapevine --help
        \`\`\`
        
        ### Direct Binary Download
        Available for all platforms:
        - Linux (x64)
        - macOS (x64 & ARM64) 
        - Windows (x64)
        
        #### macOS/Linux
        \`\`\`bash
        # Download the appropriate binary for your platform
        curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/grapevine-cli-[platform].tar.gz -o grapevine-cli.tar.gz
        tar -xzf grapevine-cli.tar.gz
        chmod +x grapevine-cli
        sudo mv grapevine-cli /usr/local/bin/
        \`\`\`
        
        #### Windows
        Download the Windows executable and add to your PATH.
        
        ## What's Changed
        See the [full changelog](https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.VERSION }}...v${{ steps.version.outputs.VERSION }})
        
        ---
        *Built with GitHub Actions*
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: release-assets/*
        fail_on_unmatched_files: true