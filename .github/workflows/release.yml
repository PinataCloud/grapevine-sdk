name: Release SDK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-publish:
    name: Build and Publish SDK
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Build SDK
      run: bun run build
    
    - name: Run unit tests
      run: bun run test:unit
    
    - name: Create tarball for GitHub release
      run: |
        tar -czf grapevine-sdk-${{ github.ref_name }}.tar.gz dist/ package.json README.md
    
    - name: Upload SDK package
      uses: actions/upload-artifact@v4
      with:
        name: sdk-package
        path: '*.tar.gz'
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [build-and-publish]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # Copy SDK package
        cp artifacts/sdk-package/*.tar.gz release-assets/
        
        # List all assets
        ls -la release-assets/
    
    - name: Extract and validate version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          INPUT_VERSION='${{ github.event.inputs.version }}'
          # Validate version format (semver: X.Y.Z with optional pre-release)
          if [[ ! "$INPUT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid version format. Expected semver (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi
          echo "VERSION=$INPUT_VERSION" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release Notes
      run: |
        cat > release-notes.md << EOF
        # Grapevine SDK Release v${{ steps.version.outputs.VERSION }}
        
        ## ðŸ“¦ SDK Package
        - **npm**: \`npm install @pinata/grapevine-sdk\`
        - **GitHub**: Download the tarball from release assets
        - TypeScript/JavaScript SDK for Grapevine API with wagmi integration
        
        ## ðŸ–¥ï¸ CLI 
        The Grapevine CLI is now available as a separate Go application:
        
        **[Grapevine CLI](https://github.com/PinataCloud/grapevine-cli)**
        
        \`\`\`bash
        npm install -g @pinata/grapevine-cli
        \`\`\`
        
        ## What's Changed
        See the [full changelog](https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.VERSION }}...v${{ steps.version.outputs.VERSION }})
        
        ---
        *Built with GitHub Actions*
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: release-assets/*
        fail_on_unmatched_files: true